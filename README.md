# HydroGraph-TW 台灣水文圖資資料庫

台灣河川與水文監測站資料整理與分析專案

## 📁 專案結構

```
HydroGraph-TW/
├── file/
│   ├── 台灣地區河川代碼(112年).pdf          # 原始河川代碼PDF
│   └── 110年度全臺839子集水區範圍圖_UTF8.shp # 集水區GIS資料
├── data/
│   ├── 測站基本資料2025.xlsx               # 原始測站資料（水位、氣象、地下水）
│   ├── 河川關係_完整版.xlsx                # 處理後的河川階層資料 (832條)
│   ├── 測站資料_水位與氣象.xlsx            # 處理後的測站資料 (826個)
│   └── 測站河川配對分析報表.xlsx          # 最終配對分析報表
├── scripts/
│   ├── 1_extract_rivers_from_pdf.py        # 從PDF提取河川資料
│   ├── 2_extract_stations.py               # 提取測站資料
│   └── 3_generate_final_report.py          # 產生最終配對報表
└── venv/                                    # Python虛擬環境
```

## 🚀 快速開始

### 環境需求
- Python 3.8+
- 所需套件：pandas, openpyxl, pdfplumber, geopandas

### 安裝依賴
```bash
# 啟動虛擬環境
venv\Scripts\activate  # Windows
source venv/bin/activate  # Linux/Mac

# 安裝套件（如需要）
pip install pandas openpyxl pdfplumber geopandas
```

### 執行流程

#### 步驟1：提取河川資料
```bash
python scripts/1_extract_rivers_from_pdf.py
```
- **輸入**：`file/台灣地區河川代碼(112年).pdf`
- **輸出**：`data/河川關係_完整版.xlsx`
- **功能**：
  - 從PDF提取832條河川資料
  - 建立5層河川階層關係（主流→支流→次支流→...）
  - 處理多行河川名稱合併
  - 過濾無效資料（短名稱、空白代碼等）

#### 步驟2：提取測站資料
```bash
python scripts/2_extract_stations.py
```
- **輸入**：`data/測站基本資料2025.xlsx`
- **輸出**：`data/測站資料_水位與氣象.xlsx`
- **功能**：
  - 提取水位測站（242個）+ 氣象測站（584個）
  - 清理文字欄位空白（重要！避免匹配失敗）
  - 排除地下水位測站

#### 步驟3：產生配對報表
```bash
python scripts/3_generate_final_report.py
```
- **輸入**：
  - `data/河川關係_完整版.xlsx`
  - `data/測站資料_水位與氣象.xlsx`
- **輸出**：`data/測站河川配對分析報表.xlsx`（5個工作表）
- **功能**：
  - **智能匹配**：處理河川名稱別名（如：`東興坑溪【東坑溪】`）
  - **5個工作表**：
    1. 摘要統計
    2. 能配對的測站（737個）
    3. 無法配對的測站（89個）
    4. 有測站的河川（181條）
    5. 沒有測站的河川（651條，監測盲點）

## 📊 資料統計

### 測站配對結果
| 項目 | 數量 | 百分比 |
|------|------|--------|
| 總測站數 | 826 | 100% |
| 能配對的測站 | 737 | 89.2% |
| 無法配對的測站 | 89 | 10.8% |

**匹配方式**：
- 直接匹配：736個 (99.9%)
- 別名匹配：1個 (0.1%)

### 河川配對統計
| 項目 | 數量 | 百分比 |
|------|------|--------|
| 總河川數 | 832 | 100% |
| 已配對的河川 | 181 | 21.8% |
| 未配對的河川 | 651 | 78.2% |

**注意**：「未配對」不代表該河川沒有監測，可能原因包括：
- 測站資料未記錄河川欄位（22個測站）
- 河川名稱使用別名或地方性稱呼
- 測站設置在主流但未標註所有支流

**按階層統計**（已配對河川）：
- 階層1（主流）：56/146 (38.4%)
- 階層2（支流）：87/336 (25.9%)
- 階層3（次支流）：35/249 (14.1%)
- 階層4：3/95 (3.2%)
- 階層5：0/6 (0.0%)

### 無法配對原因
| 原因 | 數量 | 百分比 |
|------|------|--------|
| 其他（可能是小支流） | 60 | 67.4% |
| 河川欄位為空 | 22 | 24.7% |
| 其他問題 | 4 | 4.5% |
| 排水系統 | 2 | 2.2% |
| 資料錯誤 | 1 | 1.1% |

## 🔍 重要發現

### 1. 數據品質問題
- **尾隨空白**：原始測站資料有大量尾隨空白，需清理才能正確匹配
- **河川重名**：27條河川（如「加龍橋」、「北斗排」）在不同水系中重複出現

### 2. 河川名稱變體
智能匹配成功處理以下格式：
- 括號別名：`乾溪(里仁溪)` → 可匹配 `乾溪` 或 `里仁溪`
- 中括號別名：`東興坑溪【東坑溪】` → 可匹配兩個名稱
- 全形括號：`那都魯薩溪（老人溪）` → 同樣支援

### 3. 資料配對發現
- **78.2%的河川未能配對到測站**（651條，有待進一步查證）
- 可能原因包括資料記錄方式差異、名稱不一致等
- 建議配合水利署官網或實地資料交叉確認

## 🛠️ 技術細節

### 改進的匹配邏輯
```python
def extract_river_names(text):
    """提取所有可能的河川名稱（主名稱+別名）"""
    # 1. 移除括號得主名稱
    main_name = re.sub(r'[\[\]【】\(\)（）].*?[\]\】\)\）]', '', text)

    # 2. 提取括號內的別名
    aliases = re.findall(r'[\[\【\(\（](.*?)[\]\】\)\）]', text)

    return [main_name] + aliases
```

### 數據清理
- 移除尾隨空白：`'蘭陽溪          '` → `'蘭陽溪'`
- 合併多行名稱：處理PDF換行問題
- 過濾無效資料：長度<3字元、空白代碼、特殊字符

## 🤖 GraphRAG 智能查詢系統

### 已完成功能

**✅ Neo4j 知識圖譜**
- 832條河川 + 839集水區 + 946測站關係
- 4種關係類型：IS_TRIBUTARY_OF, BELONGS_TO, MONITORS, PART_OF
- 支援上下游關係查詢、流域分析

**✅ LangGraph + Gemini POC** (推薦使用)
- 檔案：[scripts/langgraph_gemini_poc.py](scripts/langgraph_gemini_poc.py)
- 特性：
  - 動態 GraphRAG 查詢 (從自然語言 → Cypher 查詢)
  - 即時水文資料查詢 (WRA API)
  - 並行 API 查詢 (20 測站 2-3 秒完成)
  - 條件路由 (測站 >15 自動過濾)
  - 風險等級自動評估
  - **完全免費** (使用 Google Gemini)

**快速啟動**:
```bash
# 1. 安裝相依套件
python install.bat

# 2. 啟動 Neo4j (port 7687)
# 3. 配置密碼 (scripts/langgraph_gemini_poc.py 第 35 行)
# 4. 執行
python scripts/langgraph_gemini_poc.py
```

**✅ Dify Workflow 版本** (視覺化部署)
- 檔案：[dify/workflow_graphrag.yml](dify/workflow_graphrag.yml)
- 完整說明：[dify/README.md](dify/README.md)
- 特性：視覺化工作流、1天快速部署、易於維護

### 效能比較

| 方案 | 執行時間 | 開發時間 | 適用場景 |
|------|---------|---------|---------|
| **LangGraph + Gemini** | ~2.8秒 | 2-3天 | 生產環境、高效能需求 |
| Dify Workflow | ~3.5秒 | 1天 | 快速POC、視覺化開發 |
| LangChain Agent | ~4.2秒 | 2-3天 | 簡單工作流 |

### 查詢範例

```
使用者: 淡水河現在安全嗎?

系統回應:
【風險等級】低風險
【警戒測站】1/13
- 關渡水位站 - 水位 3.8m (二級警戒 3.5m)

【安全測站】12個
- 碧潭水位站 - 水位 1.2m (安全)
- 秀朗橋水位站 - 水位 2.1m (安全)
...

【建議】淡水河流域大致安全,請持續關注關渡站
```

## 📈 未來工作

- [x] 整合集水區GIS資料（839個子集水區）
- [x] 建立Neo4j圖資料庫
- [x] 實作 GraphRAG + TimeseriesRAG 混合架構
- [x] LangGraph 動態查詢引擎
- [ ] 加入 VectorRAG (歷史災害案例檢索)
- [ ] 串接氣象局預報 API
- [ ] 時間序列預測 (未來3小時趨勢)
- [ ] WebSocket 即時推播系統
- [ ] 分析測站覆蓋密度
- [ ] 識別關鍵監測缺口
- [ ] 視覺化河川階層關係

## 📝 注意事項

1. **測站資料來源**：經濟部水利署水文資訊網
2. **河川欄位為空**：22個測站原始資料就沒有河川資訊（正常現象）
3. **匹配邏輯**：優先直接匹配，其次別名匹配
4. **Excel凍結窗格**：所有輸出表格都設定了第一行凍結

## 🤝 貢獻

本專案由Claude Code協助開發，用於整理台灣水文監測數據。

## 📄 授權

資料來源：
- 河川代碼：經濟部水利署
- 測站資料：經濟部水利署水文資訊網
- 集水區圖資：經濟部水利署
