# DIFY Agent 輸出格式優化指南

## 問題描述

使用者希望 DIFY Agent 的回答：
1. **有隨機性**：不要每次都用相同句式，回答要有變化
2. **保持精準**：基於工具返回的真實資料，不能編造
3. **格式規範**：
   - 第一行：LLM 自然語言摘要（針對用戶問題）
   - 後續內容：結構化展示資料
4. **支流展示改進**：從「按層級分組」改為「按主支流分組」，清楚顯示階層關係

---

## 解決方案

### 方案 1：改進工具輸出格式

**工具文件**：`getRiverTributaries_formatted.py`

#### 改進內容

1. **返回結構化資料**：
```json
{
    "success": true,
    "count": 68,
    "summary": "「蘭陽溪」共有 68 個支流，其中 34 個直接匯入主河川...",
    "tributaries": [
        {
            "name": "宜蘭河(宜蘭溪)",
            "level": 2,
            "depth": 1,
            "sub_tributaries": [
                {
                    "name": "大礁溪",
                    "level": 3,
                    "depth": 2,
                    "sub_tributaries": []
                }
            ]
        }
    ],
    "formatted_output": "【蘭陽溪】的支流結構：\n├─ 宜蘭河(宜蘭溪)\n│  ├─ 大礁溪\n│  └─ 小礁溪\n..."
}
```

2. **樹狀結構展示**：
```
【蘭陽溪】的支流結構：

├─ 宜蘭河(宜蘭溪)
│  ├─ 大礁溪
│  │  └─ 柑仔坑溪
│  ├─ 小礁溪
│  └─ 安農溪
│     └─ 萬富大排
├─ 羅東溪
│  ├─ 安農溪
│  └─ 打狗溪
└─ 清水溪
   ├─ 牛鬥坑溪
   └─ 阿里山溪
```

---

### 方案 2：優化 DIFY Agent Prompt

在 DIFY Agent 的系統提示詞中加入以下指導：

```markdown
## 回答格式指南

當用戶詢問河川支流時，你的回答應該包含兩部分：

### 1. 自然語言摘要（第一段）
- 根據工具返回的 `summary` 欄位，用**自己的話**重新表達
- 可以用不同的句式、順序來回答，但內容必須基於真實資料
- 展現對問題的理解

**變化範例**：

假設 summary 是："「蘭陽溪」共有 68 個支流，其中 34 個直接匯入主河川"

你可以這樣回答（選擇其中一種，或創造新的說法）：
- ✅ "蘭陽溪的支流系統相當龐大，總共有 68 條支流，其中有 34 條直接匯入蘭陽溪主流。"
- ✅ "根據資料，蘭陽溪包含 68 條支流河川，約一半（34 條）是直接匯入的一級支流。"
- ✅ "蘭陽溪水系匯集了 68 條大小支流，直接流入主河道的就有 34 條。"

**禁止**：
- ✗ 每次都用完全相同的句式和順序
- ✗ 編造不在資料中的數字或名稱

### 2. 結構化展示（後續段落）
- 直接使用工具返回的 `formatted_output` 欄位
- 保持原有的樹狀結構和縮排
- 不要修改支流名稱和階層關係

---

## 完整範例

### 用戶問題 1
> 蘭陽溪有哪些支流？

### Agent 回答（版本 A）
```
蘭陽溪的支流系統相當發達，共匯集了 68 條支流河川。其中 34 條是直接匯入蘭陽溪主河道的一級支流，包括宜蘭河、羅東溪、清水溪等主要河川。整個支流網絡最深可達第 3 層。

以下是完整的支流結構：

【蘭陽溪】的支流結構：

├─ 宜蘭河(宜蘭溪)
│  ├─ 大礁溪
│  ├─ 小礁溪
│  └─ 安農溪
├─ 羅東溪
│  ├─ 安農溪
│  └─ 打狗溪
└─ 清水溪
   ├─ 牛鬥坑溪
   └─ 阿里山溪
... (完整列表)
```

### Agent 回答（版本 B - 不同表達）
```
根據資料顯示，蘭陽溪水系包含 68 條大小支流。值得注意的是，有 34 條河川直接匯入蘭陽溪，其中以宜蘭河、羅東溪、清水溪等為主要支流。支流網絡結構可達 3 層深度。

支流分布如下：

【蘭陽溪】的支流結構：
... (同樣的樹狀結構)
```

---

## 參數設定建議

### DIFY Agent 設定

1. **Temperature（溫度）**：
   - 建議設定：`0.7 - 0.8`
   - 說明：允許一定的創意變化，但不會偏離事實
   - 0.5 以下：回答太固定，缺乏變化
   - 1.0 以上：可能產生不準確的表述

2. **Top P**：
   - 建議設定：`0.9`
   - 說明：控制回答的多樣性

3. **System Prompt 重點**：
```markdown
你是水利資訊助理。回答用戶問題時：

1. **精準性**：所有數字、名稱必須來自工具返回的資料
2. **變化性**：用不同的句式和表達方式回答，避免重複
3. **結構性**：先用自然語言摘要，再提供結構化資料

當工具返回 `summary` 時，用自己的話重新組織，但不改變核心資訊。
當工具返回 `formatted_output` 時，完整保留樹狀結構。
```

---

## 工具整合方式

### 步驟 1：在 DIFY 中創建新工具

1. 工具名稱：`getRiverTributariesFormatted`
2. 工具描述：查詢河川的所有支流，並返回階層化的結構資料
3. 輸入參數：
   - `riverName` (string)：河川名稱
4. 代碼：使用 `getRiverTributaries_formatted.py` 中的 `main()` 函數

### 步驟 2：測試工具

```python
result = getRiverTributariesFormatted("蘭陽溪")
print(result["summary"])          # 摘要資訊
print(result["formatted_output"]) # 樹狀結構
```

### 步驟 3：在 Agent Prompt 中引用

```markdown
當用戶詢問支流時：
1. 調用 `getRiverTributariesFormatted` 工具
2. 用自己的話解釋 `summary` 欄位的內容
3. 展示 `formatted_output` 欄位的樹狀結構
```

---

## 效果對比

### 舊版格式（按層級分組）
```
蘭陽溪的支流：

二級支流（34個）：
- 宜蘭河、羅東溪、清水溪...

三級支流（18個）：
- 大礁溪、小礁溪、安農溪...

四級支流（11個）：
- 柑仔坑溪、萬富大排...
```

**問題**：看不出哪個支流屬於哪個主支流

### 新版格式（按主支流分組）
```
【蘭陽溪】的支流結構：

├─ 宜蘭河(宜蘭溪)
│  ├─ 大礁溪
│  └─ 小礁溪
├─ 羅東溪
│  ├─ 安農溪
│  └─ 打狗溪
└─ 清水溪
```

**優點**：清楚顯示階層關係，一目了然

---

## 總結

✅ **工具改進**：`getRiverTributaries_formatted.py` 提供結構化輸出
✅ **LLM 設定**：Temperature 0.7-0.8，允許表達變化但保持精準
✅ **Prompt 指導**：要求 LLM 重新組織語言，但不改變事實
✅ **輸出格式**：自然語言摘要 + 樹狀結構展示

這樣既能保證回答的多樣性（不會每次都一樣），又能確保資料的準確性（基於真實查詢結果）！
