# HydroGraph-TW Neo4j + APOC Extended
# 開發和部署環境一致！
#
# 使用方式：
#   啟動：docker compose up -d
#   停止：docker compose down
#   查看日誌：docker compose logs -f neo4j
#   重啟：docker compose restart
#
# 網頁介面：http://localhost:7474
# 帳號：neo4j / 密碼：geoinfor

services:
  neo4j:
    image: neo4j:5.26.0-community
    container_name: hydrograph-neo4j
    ports:
      - "7474:7474"  # Neo4j Browser（網頁介面）
      - "7687:7687"  # Bolt（程式連線用）
    environment:
      # 認證設定
      - NEO4J_AUTH=neo4j/geoinfor

      # 使用本地 plugins 目錄（包含 APOC Core + Extended）
      # 不使用 NEO4J_PLUGINS，避免覆蓋 Extended JAR

      # APOC 權限設定
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*

      # 記憶體設定（可依需求調整）
      - NEO4J_server_memory_heap_initial__size=512m
      - NEO4J_server_memory_heap_max__size=2G
      - NEO4J_server_memory_pagecache_size=1G

    volumes:
      # 資料持久化
      - neo4j_data:/data
      - neo4j_logs:/logs
      # 使用本地 plugins 目錄（包含 APOC Extended）
      - ./plugins:/plugins

    # 開機自動啟動！
    restart: always

    # 健康檢查
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

# 命名卷（資料持久化）
volumes:
  neo4j_data:
    name: hydrograph_neo4j_data
  neo4j_logs:
    name: hydrograph_neo4j_logs
  neo4j_plugins:
    name: hydrograph_neo4j_plugins
