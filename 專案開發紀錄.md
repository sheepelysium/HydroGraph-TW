# 台灣水文知識圖譜 GraphRAG 系統 - 開發紀錄

## 專案概述

**專案名稱**: HydroGraph-TW (台灣水文知識圖譜系統)

**技術棧**:
- **圖資料庫**: Neo4j
- **對話 AI**: DIFY + LLM
- **後端**: Python + Flask
- **資料來源**: 水利署開放資料、河川局測站資料

**核心功能**:
- 知識圖譜查詢 (河川、測站、集水區拓撲關係)
- 即時監測資料整合 (模擬 WRA API)
- 災害知識庫 RAG (歷史案例、防災手冊)

---

## 開發歷程

### 階段 1: 資料匯入與 Schema 建立

#### 問題 1: 資料庫名稱錯誤
- **現象**: 匯入腳本連接到 `hydrograph-tw` 資料庫失敗
- **原因**: 使用者實際使用的是預設的 `neo4j` 資料庫
- **解決**: 在所有 `driver.session()` 呼叫中加入 `database="neo4j"` 參數
- **影響檔案**:
  - `scripts/5_import_rivers_to_neo4j.py`
  - `scripts/6_import_watersheds_to_neo4j.py`
  - `scripts/7_import_stations_to_neo4j.py`
  - `scripts/8_import_all_to_neo4j.py`

#### 問題 2: 編碼問題
- **現象**: `'cp950' codec can't encode character` 錯誤
- **原因**: Windows 控制台無法顯示 emoji 符號 (✅, ❌, ⚠️)
- **解決**: 將所有 emoji 替換為 ASCII 符號 `[OK]`, `[X]`, `[WARNING]`
- **特殊處理**: km² 中的上標符號也需要改為 `km2`

#### 問題 3: 舊關係名稱不符合 DIFY 標準
- **現象**: 原始 Schema 使用 `IS_TRIBUTARY_OF`, `MONITORS` 等關係
- **需求**: DIFY Agent Prompt 使用 `FLOWS_INTO`, `LOCATED_ON`, `DRAINS_TO`
- **解決**: 建立 `migrate_to_dify_schema.py` 腳本進行轉換
- **轉換內容**:
  ```
  IS_TRIBUTARY_OF → FLOWS_INTO (686 條)
  MONITORS → LOCATED_ON (209 條)
  CONTAINS_RIVER → DRAINS_TO (21,281 條)
  Rainfall → RainStation (242 個)
  WaterLevel → WaterStation (584 個)
  ```

#### 最終資料統計
- **節點**:
  - River: 831 條
  - WaterSystem: 146 個
  - Basin: 136 個
  - Watershed: 839 個
  - Station: 826 個 (RainStation: 242, WaterStation: 584)

- **關係**:
  - FLOWS_INTO: 686 條 (支流→主流)
  - LOCATED_ON: 209 條 (測站→河川)
  - DRAINS_TO: 21,281 條 (集水區→河川)
  - BELONGS_TO: 831 條 (河川→水系)
  - PART_OF: 839 條 (集水區→流域)

---

### 階段 2: GraphRAG Demo 開發

#### 初版問題
- **問題**: 只有圖資料庫,不是真正的 GraphRAG
- **使用者反饋**: "這樣就算是 graphrag 了嗎? 但我想要的是一些應用"
- **解決**: 建立 `graphrag_demo.py` 展示 RAG 三個組件:
  - **R (Retrieval)**: 從 Neo4j 檢索相關資料
  - **A (Augmented)**: 用檢索結果增強 LLM Prompt
  - **G (Generation)**: 用 Gemini LLM 生成自然語言答案

#### DIFY Schema 版本
- **檔案**: `graphrag_dify_demo.py`
- **改進**: 使用 DIFY 標準的關係名稱
- **情境展示**:
  1. 汙染溯源分析 (上下游查詢)
  2. 監測站查詢 (詳細資訊)
  3. 集水區分析 (排水關係)
  4. 水系網絡統計
  5. 複雜路徑 GraphRAG 查詢

---

### 階段 3: 測站查詢問題排查

#### 問題: "中山橋測站查不到資料"
- **現象**: DIFY Agent 回覆"中山橋沒有水位測站資料"
- **排查過程**:
  1. 確認測站存在: `MATCH (s:Station) WHERE s.name CONTAINS '中山橋'` → 有資料
  2. 檢查關係: `MATCH (s:Station {name: '中山橋'})-[:LOCATED_ON]->()` → 沒有關係!
  3. 發現問題: 測站的 `river` 欄位有空格 (`'景美溪              '`)
  4. 匹配失敗: 原本的匯入腳本無法正確匹配河川名稱

- **解決方案**:
  1. 建立 `fix_station_relationships.py` 修復關係
  2. 使用 `trim(s.river)` 去除空格重新匹配
  3. 成功建立 687 條額外的 `LOCATED_ON` 關係
  4. 手動修正中山橋: 原以為在景美溪,實際在基隆河

#### 關鍵教訓
- ✅ 資料清洗很重要 (空格、編碼問題)
- ✅ 測站名稱需要用 `CONTAINS` 模糊匹配 (因為有空格)
- ✅ 不要用 `RETURN s` (會有 DateTime 序列化錯誤)

---

### 階段 4: DIFY Agent Prompt 優化

#### 初版 Prompt 問題
- **Token 消耗**: ~6000 tokens (太長!)
- **原因**: 包含太多查詢範例

#### 優化策略
1. **刪除重複範例**: 相似的查詢只保留一個
2. **合併說明**: 把冗長的解釋精簡化
3. **保留核心功能**: 所有關鍵查詢都還在

#### 最終版本
- **檔案**: `DIFY_AGENT_PROMPT_精簡版.md`
- **Token 數**: ~2000 tokens (降低 67%!)
- **保留功能**:
  - 單一/多個測站查詢
  - 測站類型區分 (RainStation/WaterStation)
  - 極值查詢 (最高/最低)
  - 統計查詢
  - 河川與流域查詢
  - 智能匹配邏輯

---

### 階段 5: WRA API 調查

#### 目標
整合水利署即時監測 API 取得測站災害風險資訊 (雷擊、淹水等)

#### 調查結果
- **API 端點**: `https://gweb.wra.gov.tw/HydroInfo/Comm/GetSTInfo`
- **測試結果**: ❌ 需要登入,返回錯誤頁面
  ```html
  <title>系統錯誤</title>
  您目前尚[資料存取],請重新登入!
  ```
- **結論**: 不是公開 API,無法直接使用

#### 替代方案
1. **短期**: 更新 Agent Prompt,用現有資料推論
   - 雷擊風險: 高海拔測站 (>500m)
   - 淹水風險: 低海拔測站 (<50m)

2. **中期**: 手動整理重要測站的災害資訊,建立知識庫

3. **長期**: 建立模擬工具展示概念 (已實作)

---

### 階段 6: Agent 架構討論

#### 問題探討

**Q: 功能越多,Prompt 會爆炸嗎?**
- **A**: 是的!但有解決方案

**Q: 需要很多工具嗎?**
- **A**: 不需要!一個通用 `neo4j_query` 工具就夠了

**Q: 需要多個 Agent 嗎?**
- **A**: 不一定!看複雜度

#### 真實 Agent 系統的設計

**方案 A: 通用查詢工具 (目前採用)** ⭐
```
Agent → neo4j_query(cypher, params)
```
- ✅ 最靈活
- ✅ Agent 自己生成 Cypher 查詢
- ✅ OpenAI/Gemini 都這樣做

**方案 B: 少量高層工具**
```
Agent → search_stations(filters)
      → analyze_river_network(river, type)
      → get_basin_statistics(basin)
```
- ✅ 工具數量少 (5-10 個)
- ❌ 需要複雜的工具實作

**方案 C: Agent 自己寫程式 (最先進)**
```
Agent → execute_code(python_code)
```
- ✅ 超級靈活
- ❌ 需要安全沙箱

---

### 階段 7: POC 整合方案

#### 最終架構

```
台灣水文 GraphRAG 系統
│
├─ [核心] Neo4j 知識圖譜
│   └─ 河川、測站、集水區拓撲關係
│
├─ [即時監測] WRA API 工具
│   └─ Flask API (模擬即時資料)
│
├─ [歷史知識] DIFY 知識庫
│   ├─ 災害案例.md
│   └─ 防災手冊.md
│
└─ [查詢介面] DIFY Agent
    ├─ 靜態查詢 → Neo4j
    ├─ 即時查詢 → WRA 工具
    └─ 知識問答 → 知識庫 RAG
```

#### 實作成果

**1. WRA 即時監測工具** (`dify_tools/wra_realtime_tool.py`)
- Flask HTTP API
- 整合 Neo4j 測站資訊
- 模擬即時水位/雨量資料
- 可在 DIFY 註冊為自訂工具

**2. 災害知識庫** (`knowledge_base/`)
- **災害案例.md**:
  - 2024年颱風凱米
  - 2023年豪雨事件
  - 常見災害類型 (淹水、土石流、設備損壞)

- **防災手冊.md**:
  - 緊急聯絡資訊
  - 測站異常處理流程
  - 數據判讀標準
  - 三級警戒機制

**3. 整合指南** (`POC_整合指南.md`)
- 完整的整合步驟
- 測試清單
- 使用範例
- 擴展建議

---

## 技術決策記錄

### 為什麼不用向量知識庫存測站資料?
- ❌ **原因**: 脫褲子放屁
- ✅ **方案**: Neo4j 圖譜本身就是最好的測站資料庫,用模糊匹配即可

### 為什麼不需要 100 個專門工具?
- ❌ **問題**: 工具太多,Agent 選不出來
- ✅ **方案**: 一個通用 `neo4j_query` 工具,讓 Agent 自己生成 Cypher

### 為什麼不需要多個 Agent?
- ❌ **誤解**: 以為需要測站 Agent、河川 Agent、統計 Agent
- ✅ **真相**: 單 Agent + 通用工具 + 知識庫 RAG 就夠了
- ✅ **進階**: 只有需要複雜推理時才需要多 Agent

### NeoDash vs 自訂前端
- **NeoDash**: 快速原型,不需寫代碼,但客製化有限
- **自訂前端 + DIFY API**: 完全客製化,可整合到現有系統
- **建議**: 先用 NeoDash 驗證,再開發自訂前端

---

## 專案文件結構

```
HydroGraph-TW/
├── README.md
├── requirements.txt
├── .env                           # API Keys 設定
├── .gitignore                     # 保護敏感資訊
│
├── scripts/                       # 資料匯入腳本
│   ├── 5_import_rivers_to_neo4j.py
│   ├── 6_import_watersheds_to_neo4j.py
│   ├── 7_import_stations_to_neo4j.py
│   └── 8_import_all_to_neo4j.py
│
├── data/                          # 原始資料
│   ├── rivers_data.xlsx
│   ├── stations_data.xlsx
│   └── watersheds_data.xlsx
│
├── dify_tools/                    # DIFY 自訂工具
│   └── wra_realtime_tool.py      # 即時監測 API
│
├── knowledge_base/                # 知識庫文件
│   ├── 災害案例.md
│   └── 防災手冊.md
│
├── graphrag_dify_demo.py          # GraphRAG 展示程式 ⭐
├── clear_neo4j.py                 # 清空資料庫工具
├── fix_station_relationships.py  # 修復測站關係
├── migrate_to_dify_schema.py     # Schema 轉換腳本
│
├── DIFY_AGENT_PROMPT_精簡版.md    # DIFY Agent Prompt ⭐
├── POC_整合指南.md                 # 整合指南 ⭐
├── 專案開發紀錄.md                 # 本文件
└── LANGGRAPH_GEMINI_使用說明.md
```

---

## 核心檔案說明

### 1. `graphrag_dify_demo.py`
**用途**: 展示完整的 GraphRAG 應用

**功能**:
- 汙染溯源分析 (FLOWS_INTO 關係)
- 監測站詳細查詢
- 集水區排水分析 (DRAINS_TO)
- 水系網絡統計
- 複雜 GraphRAG 查詢

**執行**:
```bash
python graphrag_dify_demo.py
```

### 2. `DIFY_AGENT_PROMPT_精簡版.md`
**用途**: DIFY Agent 的核心 Prompt

**特點**:
- 精簡到 ~2000 tokens
- 包含所有關鍵查詢模板
- 智能匹配邏輯
- 錯誤處理指南

**使用**: 複製內容到 DIFY Agent Prompt 欄位

### 3. `dify_tools/wra_realtime_tool.py`
**用途**: 即時監測資料 API 工具

**功能**:
- 整合 Neo4j 測站資訊
- 模擬即時水位/雨量
- 返回警戒狀態
- 可在 DIFY 註冊為 HTTP 工具

**啟動**:
```bash
python dify_tools/wra_realtime_tool.py
```

**API**:
```bash
POST http://localhost:5000/query_realtime
{
  "station_name": "中山橋"
}
```

---

## 常見問題與解決方案

### Q1: 中文顯示亂碼
**A**: Windows 控制台編碼問題
- 避免使用 emoji
- 特殊符號改用 ASCII (km² → km2)

### Q2: 測站查不到資料
**A**: 檢查步驟
1. 確認測站存在: `MATCH (s:Station) WHERE s.name CONTAINS 'XX'`
2. 檢查關係: `MATCH (s)-[:LOCATED_ON]->() WHERE s.name CONTAINS 'XX'`
3. 如果關係缺失: 執行 `fix_station_relationships.py`

### Q3: Cypher 查詢報錯 "DateTime serialization"
**A**: 不要 `RETURN s`,明確指定屬性
```cypher
❌ RETURN s
✅ RETURN s.name, s.code, s.type
```

### Q4: DIFY Agent Prompt 太長
**A**: 使用精簡版 Prompt + 知識庫 RAG
- Prompt 只放核心規則 (~2000 tokens)
- 查詢範例放知識庫,讓 Agent 自己檢索

### Q5: WRA API 無法使用
**A**: 使用模擬工具展示概念
- 執行 `wra_realtime_tool.py`
- 未來可整合其他公開 API

---

## 效能與成本

### Token 消耗
- **優化前**: ~6000 tokens/query
- **優化後**: ~2000 tokens/query
- **節省**: 67%

### 查詢速度
- **Neo4j 圖譜查詢**: <100ms
- **LLM 生成**: 1-3秒
- **總體**: <5秒

### 資料規模
- **節點**: 2,659 個
- **關係**: 23,642 條
- **Neo4j 記憶體**: <500MB

---

## 下一步規劃

### 短期 (1 週)
- [x] 完成基本 GraphRAG 功能
- [x] 建立 WRA 工具模擬
- [x] 建立災害知識庫
- [ ] 完成 DIFY 整合測試
- [ ] 準備 Demo 展示

### 中期 (1 個月)
- [ ] 真實 WRA API 整合 (若可用)
- [ ] 擴充災害案例知識庫
- [ ] NeoDash 儀表板開發
- [ ] 自訂前端開發

### 長期 (3 個月)
- [ ] 歷史資料分析功能
- [ ] 災害預測模型
- [ ] WebSocket 即時推播
- [ ] 完整系統部署

---

## 參考資源

### 官方文件
- Neo4j 文檔: https://neo4j.com/docs/
- DIFY 文檔: https://docs.dify.ai/
- LangGraph 文檔: https://python.langchain.com/docs/langgraph

### 相關專案
- DIFY Agent 範例
- Neo4j GraphRAG 案例
- 台灣開放資料平台

### 技術文章
- GraphRAG vs 傳統 RAG
- Agent 系統設計模式
- Neo4j 效能優化

---

## 貢獻者

**開發**: [使用者]
**技術支援**: Claude (Anthropic)
**資料來源**: 水利署、河川局

---

## 授權

本專案為 POC 概念驗證,資料來源為政府開放資料。

---

**文件版本**: 1.0
**更新日期**: 2025-01-XX
**狀態**: 進行中 ✅
