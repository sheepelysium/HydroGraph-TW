# å‹•æ…‹æ°´æ–‡çŸ¥è­˜åœ–è­œ - æ”¹é€²æ–¹æ¡ˆ

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ: éœæ…‹åœ–è­œ + å‹•æ…‹æ™‚åº

### å•é¡Œè¨ºæ–·
åŸæµç¨‹çš„ GraphRAG åªæŸ¥éœæ…‹å±¬æ€§,æ²’æœ‰ç™¼æ®åœ–çš„å„ªå‹¢!

### è§£æ±ºæ–¹æ¡ˆ: ä¸‰å±¤æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ä½¿ç”¨è€…å•é¡Œ: "æ·¡æ°´æ²³ç¾åœ¨å®‰å…¨å—?"                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   å•é¡Œåˆ†è§£ & æ„åœ–è­˜åˆ¥ (LLM)          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         æ··åˆæŸ¥è©¢å¼•æ“                 â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
        â”‚  â”‚GraphRAG â”‚TimeRAG  â”‚VectorRAGâ”‚   â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“          â†“          â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Neo4j  â”‚ â”‚ TimescaleDBâ”‚ â”‚ChromaDB â”‚
        â”‚  åœ–è­œ   â”‚ â”‚ æ™‚åºè³‡æ–™  â”‚ â”‚ å‘é‡åº«  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š å¯¦ä½œç´°ç¯€

### 1. GraphRAG (Neo4j) - ç©ºé–“é—œä¿‚æŸ¥è©¢

**ç”¨é€”**: æŸ¥è©¢"å“ªäº›æ¸¬ç«™æœƒå—å½±éŸ¿"

```python
# âœ… æ­£ç¢ºçš„ GraphRAG ä½¿ç”¨
def query_affected_stations(river_name: str):
    """
    æ‰¾å‡ºæŸæ¢æ²³å·çš„ä¸Šä¸‹æ¸¸æ‰€æœ‰æ¸¬ç«™
    é€™æ‰æ˜¯åœ–è­œçš„åƒ¹å€¼!ä¸æ˜¯æŸ¥éœæ…‹å±¬æ€§!
    """
    query = """
    MATCH path = (upstream:River)-[:FLOWS_INTO*]->(r:River {name: $name})
    WITH upstream
    MATCH (s:Station)-[:LOCATED_ON]->(upstream)
    RETURN DISTINCT s.code AS ç«™è™Ÿ,
                    s.name AS æ¸¬ç«™åç¨±,
                    upstream.name AS æ‰€åœ¨æ²³å·,
                    length(path) AS ä¸Šæ¸¸è·é›¢
    ORDER BY ä¸Šæ¸¸è·é›¢ DESC
    """
    # é€™å€‹æŸ¥è©¢ç”¨ SQL åšä¸åˆ°!é€™æ‰æ˜¯ GraphRAG!
```

**ç¯„ä¾‹æŸ¥è©¢**:
```cypher
// æ‰¾å‡ºæ·¡æ°´æ²³æµåŸŸæ‰€æœ‰å¯èƒ½æ·¹æ°´çš„å€åŸŸ
MATCH (r:River {name: 'æ·¡æ°´æ²³'})<-[:FLOWS_INTO*]-(tributary:River)
MATCH (w:Watershed)-[:DRAINS_TO]->(tributary)
MATCH (s:Station)-[:LOCATED_IN]->(w)
RETURN w.name AS é›†æ°´å€,
       collect(s.name) AS ç›£æ¸¬ç«™,
       w.area_km2 AS é¢ç©
ORDER BY w.area_km2 DESC
```

---

### 2. TimeseriesRAG (TimescaleDB) - å³æ™‚ç›£æ¸¬

**ç”¨é€”**: æŸ¥è©¢"ç¾åœ¨/æœ€è¿‘çš„æ•¸æ“š"

```python
# âœ… å‹•æ…‹æŸ¥è©¢
def query_realtime_rainfall(station_codes: list):
    """
    æŸ¥è©¢æœ€è¿‘24å°æ™‚çš„é›¨é‡
    æ•´åˆ WRA API
    """
    results = []
    for code in station_codes:
        data = wra_api.get_timeseries_data(
            station_code=code,
            data_category="rain",
            time_range="hourly",
            start_date=(datetime.now() - timedelta(hours=24)).strftime("%Y-%m-%d"),
            end_date=datetime.now().strftime("%Y-%m-%d")
        )
        results.append({
            'station': code,
            'total_24h': sum([d['rainfall'] for d in data]),
            'max_hourly': max([d['rainfall'] for d in data]),
            'trend': analyze_trend(data)  # ä¸Šå‡/ä¸‹é™/ç©©å®š
        })
    return results
```

**è³‡æ–™çµæ§‹**:
```sql
-- TimescaleDB æ™‚åºè¡¨
CREATE TABLE station_rainfall (
    time TIMESTAMPTZ NOT NULL,
    station_code VARCHAR(10) NOT NULL,
    rainfall_mm DECIMAL(10,2),
    water_level_m DECIMAL(10,2),
    PRIMARY KEY (time, station_code)
);

-- å»ºç«‹è¶…è¡¨ (Hypertable)
SELECT create_hypertable('station_rainfall', 'time');

-- æŒçºŒèšåˆ (Continuous Aggregates)
CREATE MATERIALIZED VIEW rainfall_hourly
WITH (timescaledb.continuous) AS
SELECT station_code,
       time_bucket('1 hour', time) AS bucket,
       avg(rainfall_mm) AS avg_rainfall,
       max(rainfall_mm) AS max_rainfall,
       count(*) AS observations
FROM station_rainfall
GROUP BY station_code, bucket;
```

---

### 3. VectorRAG (ChromaDB) - èªç¾©æŸ¥è©¢

**ç”¨é€”**: æŸ¥è©¢"æ­·å²ç½å®³æ¡ˆä¾‹"

```python
# âœ… ç½å®³æ¡ˆä¾‹æª¢ç´¢
def query_similar_disasters(current_situation: str):
    """
    æ‰¾å‡ºç›¸ä¼¼çš„æ­·å²ç½å®³
    """
    # ç•¶å‰æƒ…æ³æè¿°
    situation = f"""
    æ·¡æ°´æ²³æµåŸŸ24å°æ™‚ç´¯ç©é›¨é‡300mm
    æ–°åº—æºªä¸Šæ¸¸æ¸¬ç«™æ°´ä½ä¸Šå‡2å…¬å°º
    é æ¸¬æœªä¾†6å°æ™‚æŒçºŒé™é›¨
    """

    # å‘é‡æª¢ç´¢
    results = vector_db.query(
        query_texts=[situation],
        n_results=5
    )

    # è¿”å›æ­·å²æ¡ˆä¾‹
    return [
        {
            'event': r['metadata']['disaster_name'],
            'date': r['metadata']['date'],
            'similarity': r['distance'],
            'response': r['metadata']['emergency_response']
        }
        for r in results
    ]
```

---

## ğŸ¯ å®Œæ•´æŸ¥è©¢ç¯„ä¾‹: "æ·¡æ°´æ²³ç¾åœ¨å®‰å…¨å—?"

### Step 1: æ„åœ–è­˜åˆ¥
```python
user_question = "æ·¡æ°´æ²³ç¾åœ¨å®‰å…¨å—?"

# LLM åˆ†è§£å•é¡Œ
intents = {
    "river": "æ·¡æ°´æ²³",
    "aspect": "flood_risk",
    "timeframe": "current",
    "queries_needed": [
        "find_upstream_stations",  # GraphRAG
        "get_current_rainfall",     # TimeseriesRAG
        "find_similar_events"       # VectorRAG
    ]
}
```

### Step 2: GraphRAG - æ‰¾ç›¸é—œæ¸¬ç«™
```cypher
MATCH (r:River {name: 'æ·¡æ°´æ²³'})<-[:FLOWS_INTO*]-(upstream:River)
MATCH (s:Station)-[:LOCATED_ON]->(upstream)
RETURN s.code, s.name, upstream.name
```
â†’ å–å¾— 20 å€‹æ¸¬ç«™ä»£è™Ÿ

### Step 3: TimeseriesRAG - æŸ¥å³æ™‚é›¨é‡
```python
rainfall_data = wra_api.query_multiple_stations(
    station_codes=['466940', '466920', ...],
    hours=24
)

# åˆ†æçµæœ
analysis = {
    'total_24h': 150,  # mm
    'max_station': 'æ–°åº—æºªæ¸¬ç«™',
    'trend': 'æŒçºŒä¸Šå‡',
    'alert_level': 'æ³¨æ„'
}
```

### Step 4: VectorRAG - æ‰¾æ­·å²æ¡ˆä¾‹
```python
vector_query = f"""
æ·¡æ°´æ²³æµåŸŸ 24å°æ™‚ç´¯ç©é›¨é‡ {analysis['total_24h']}mm
æ°´ä½è¶¨å‹¢: {analysis['trend']}
"""

similar_events = vector_db.query(vector_query, n=3)
# â†’ æ‰¾åˆ° 2015å¹´è˜‡è¿ªå‹’é¢±é¢¨ã€2018å¹´æš´é›¨äº‹ä»¶
```

### Step 5: LLM ç”Ÿæˆå›ç­”
```python
prompt = f"""
æ ¹æ“šä»¥ä¸‹è³‡è¨Šå›ç­”: æ·¡æ°´æ²³ç¾åœ¨å®‰å…¨å—?

åœ–è­œè³‡æ–™(GraphRAG):
- ä¸Šæ¸¸å…±æœ‰ 20 å€‹ç›£æ¸¬ç«™
- æ¶µè“‹æ–°åº—æºªã€å¤§æ¼¢æºªã€åŸºéš†æ²³

å³æ™‚è³‡æ–™(TimeseriesRAG):
- 24å°æ™‚ç´¯ç©é›¨é‡: {analysis['total_24h']}mm
- æœ€å¤§é›¨é‡æ¸¬ç«™: {analysis['max_station']}
- è¶¨å‹¢: {analysis['trend']}

æ­·å²æ¡ˆä¾‹(VectorRAG):
- 2015å¹´è˜‡è¿ªå‹’é¢±é¢¨æ™‚ç´¯ç©é›¨é‡ 250mm,é€ æˆå±€éƒ¨æ·¹æ°´
- ç›®å‰é›¨é‡ä½æ–¼ç•¶æ™‚æ°´æº–

è«‹ç¶œåˆè©•ä¼°é¢¨éšªç­‰ç´šã€‚
"""

answer = llm.generate(prompt)
```

**æœ€çµ‚å›ç­”**:
```
ğŸ“Š æ·¡æ°´æ²³æµåŸŸå®‰å…¨è©•ä¼° (2024-01-15 14:00)

ã€ç›®å‰ç‹€æ³ã€‘
âœ… 24å°æ™‚ç´¯ç©é›¨é‡ 150mm (æ³¨æ„ç­‰ç´š)
âš ï¸ æ°´ä½è¶¨å‹¢æŒçºŒä¸Šå‡
âœ… å°šæœªé”åˆ°è­¦æˆ’æ°´ä½

ã€é¢¨éšªåˆ†æã€‘
æ ¹æ“šæ­·å²æ¡ˆä¾‹,ç›®å‰é›¨é‡ä½æ–¼ 2015å¹´è˜‡è¿ªå‹’é¢±é¢¨äº‹ä»¶(250mm),
ç•¶æ™‚é€ æˆå±€éƒ¨æ·¹æ°´ã€‚ç¾éšæ®µé¢¨éšªç­‰ç´š: ä¸­ç­‰

ã€å»ºè­°ã€‘
1. æŒçºŒç›£æ§ä¸Šæ¸¸ 20 å€‹æ¸¬ç«™
2. è‹¥æœªä¾† 6 å°æ™‚é›¨é‡è¶…é 100mm,é¢¨éšªå°‡å‡é«˜
3. æ–°åº—æºªä¸Šæ¸¸åœ°å€éœ€ç‰¹åˆ¥æ³¨æ„

ã€å³æ™‚æ•¸æ“šã€‘(æ¯10åˆ†é˜æ›´æ–°)
- æ–°åº—æºªæ¸¬ç«™: æ°´ä½ 2.5m (â†‘)
- å¤§æ¼¢æºªæ¸¬ç«™: æ°´ä½ 1.8m (â†’)
- åŸºéš†æ²³æ¸¬ç«™: æ°´ä½ 1.2m (â†‘)
```

---

## ğŸš€ ç«‹å³å¯åšçš„äº‹

### ä»Šå¤©å°±å¯ä»¥é–‹å§‹:

1. **æ•´åˆ WRA API åˆ°æ™‚åºæŸ¥è©¢**
```python
# tools/timeseries_query.py (æ–°å»º)
from tools.wra_api import get_timeseries_data
from datetime import datetime, timedelta

def get_realtime_stations_data(station_codes: list):
    """æ‰¹æ¬¡æŸ¥è©¢æ¸¬ç«™å³æ™‚è³‡æ–™"""
    results = []
    for code in station_codes:
        data = get_timeseries_data(
            station_code=code,
            data_category="rain",
            time_range="hourly",
            start_date=(datetime.now() - timedelta(hours=24)).isoformat(),
            end_date=datetime.now().isoformat()
        )
        results.append({
            'station': code,
            'data': data,
            'summary': {
                'total_24h': sum([d.get('rainfall', 0) for d in data]),
                'last_hour': data[-1].get('rainfall', 0) if data else 0
            }
        })
    return results
```

2. **ä¿®æ”¹ GraphRAG æŸ¥è©¢ (ç™¼æ®åœ–çš„å„ªå‹¢)**
```python
# api/graph_queries.py (ä¿®æ”¹)
def get_upstream_stations(river_name: str):
    """âœ… é€™æ‰æ˜¯ GraphRAG è©²åšçš„äº‹!"""
    query = """
    MATCH (r:River {name: $name})<-[:FLOWS_INTO*0..3]-(upstream)
    MATCH (s:Station)-[:LOCATED_ON]->(upstream)
    RETURN s.code AS code,
           s.name AS name,
           upstream.name AS river,
           length(path) AS distance
    ORDER BY distance
    """
    # ç”¨é€™å€‹çµæœå»æŸ¥å³æ™‚è³‡æ–™!
    with neo4j.session() as session:
        result = session.run(query, name=river_name)
        station_codes = [r['code'] for r in result]

    # ç«‹å³æŸ¥è©¢å³æ™‚è³‡æ–™
    timeseries_data = get_realtime_stations_data(station_codes)

    return {
        'graph': result,
        'timeseries': timeseries_data
    }
```

3. **å»ºç«‹æ··åˆæŸ¥è©¢ä»‹é¢**
```python
# api/hybrid_engine.py (æ–°å»º)
class HybridRAGEngine:
    def __init__(self):
        self.neo4j = Neo4jConfig()
        self.wra = WRAApiClient()
        self.vector = ChromaClient()

    def query(self, question: str):
        # 1. GraphRAG: æ‰¾ç›¸é—œæ¸¬ç«™
        stations = self.get_upstream_stations(...)

        # 2. TimeseriesRAG: æŸ¥å³æ™‚è³‡æ–™
        timeseries = self.wra.query_stations(stations)

        # 3. VectorRAG: æ‰¾æ­·å²æ¡ˆä¾‹
        cases = self.vector.find_similar(...)

        # 4. LLM: ç”Ÿæˆå›ç­”
        return self.llm.generate(graph=..., time=..., vector=...)
```

---

## âœ… ä¿®æ­£å¾Œçš„åŸ·è¡Œé †åº

### Week 1: å»ºç«‹å‹•æ…‹æŸ¥è©¢èƒ½åŠ›
- Day 1: æ•´åˆ WRA API æ‰¹æ¬¡æŸ¥è©¢
- Day 2: ä¿®æ”¹ GraphRAG æŸ¥è©¢ (ä¸Šä¸‹æ¸¸é—œä¿‚)
- Day 3: å»ºç«‹æ··åˆæŸ¥è©¢å¼•æ“
- Day 4-5: æ¸¬è©¦å‹•æ…‹æŸ¥è©¢

### Week 2: åŠ å…¥æ™‚åºè³‡æ–™åº« (é¸åš)
- å¦‚æœ WRA API é€Ÿåº¦ä¸å¤ å¿«,å†å»º TimescaleDB
- å®šæœŸåŒæ­¥ WRA è³‡æ–™åˆ°æœ¬åœ°

### Week 3: åŠ å…¥ç½å®³å‘é‡åº«
- çˆ¬å– NCDR æ­·å²ç½å®³
- å»ºç«‹å‘é‡ç´¢å¼•
- æ•´åˆåˆ°æ··åˆæŸ¥è©¢

---

## ğŸ’¡ é—œéµå·®ç•°

| åŸæ–¹æ¡ˆ | æ”¹é€²æ–¹æ¡ˆ |
|--------|----------|
| GraphRAG æŸ¥éœæ…‹å±¬æ€§ | GraphRAG æŸ¥ç©ºé–“é—œä¿‚ |
| æ²’æœ‰å³æ™‚è³‡æ–™ | æ•´åˆ WRA API |
| ç¼ºä¹å‹•æ…‹æ„Ÿ | æ¯æ¬¡æŸ¥è©¢éƒ½å«å³æ™‚æ•¸æ“š |
| èˆ‡å·²æœ‰å·¥å…·è„«ç¯€ | å……åˆ†åˆ©ç”¨ç¾æœ‰ WRA API |

---

## ğŸ¯ ç¸½çµ

**ä½ çš„å•é¡Œæ ¸å¿ƒ**:
> "è³‡æ–™å¤ªéœæ…‹,æƒ³è¦åšå‡ºå‹•æ…‹æ„Ÿ"

**è§£æ±ºæ–¹æ¡ˆ**:
âœ… **ä¸è¦åªå­˜éœæ…‹è³‡æ–™åˆ° Neo4j**
âœ… **æ¯æ¬¡æŸ¥è©¢éƒ½æ•´åˆ WRA API å³æ™‚è³‡æ–™**
âœ… **GraphRAG è² è²¬æ‰¾"å“ªäº›æ¸¬ç«™",TimeseriesRAG è² è²¬æŸ¥"æ•¸æ“šæ˜¯å¤šå°‘"**
âœ… **é€™æ‰æ˜¯çœŸæ­£çš„æ··åˆæ¶æ§‹!**

éœ€è¦æˆ‘å¹«ä½ å¯«ç¬¬ä¸€ç‰ˆçš„æ··åˆæŸ¥è©¢å¼•æ“å—? ğŸš€
